# 野火F407开发板-霸天虎视频

## 高级篇



### 28. LCD 液晶显示

#### 第1节 液晶显示器简介

#### 第2节 显示器控制原理

#### 第3节 4.5寸液晶屏简介

本节参考资料：

* 零死角玩转STM32 第28.3节
* `B盘/28-LCD--液晶显示/参考资料/1-原理图`
  * `4.5寸液晶模块原理图.pdf`
* `B盘/28-LCD--液晶显示/参考资料/3-数据手册`
  * `ILI9806G-Data Sheet for all ...`

##### 1. 4.5寸触摸屏实物

实验板标配的4.5寸电阻触摸液晶屏，分辨率为`854*480`，见图`实验板标配的4_5寸电阻触摸屏`

<img src="野火--霸天虎视频学习.assets/image-20221224095837881.png" alt="image-20221224095837881" style="zoom:50%;" />

* 图中标号3部分是液晶屏幕的整体，通过引出的排针或FPC排线接入
* 标号1为液晶触摸面板
  * 液晶触摸模板由触摸屏和触摸模板组成，这是两个独立的部件，生产厂商把这两个部件贴在了一起，形成整体。
  * 触摸面板引出的信号线引入到GT5688芯片，该芯片会对触摸信号进行采集并简化信号输出给外部控制器。
  * 液晶面板内部包含了一个型号为ILI9806G的液晶控制器芯片（由于集成度高，所以图中无法看见），该液晶控制器使用8080接口与单片机通讯，图中液晶面板引出的FPC信号线即8080接口（RGB接口已在内部直接与ILI9806G相连），且控制器中包含由显存，单片机要把显示的数据通过引出的8080接口发送到液晶控制器，这些数据会被存储到它内部的显存中，然后液晶控制器不断把显存的内容刷新到液晶面板，显示内容。
* 标号2为PCB底板部分
  * 它主要包含了液晶屏的电压控制电路
  * PCB底板与液晶触摸面板通过FPC排序座连接，然后引出到排针，方便与实验板的母线连接，也可以使用FPC接口与核心板连接。

##### 2. ILI9806G液晶控制器简介

本液晶屏内部包含有一个液晶控制芯片ILI9806G，它的内部结构非常复杂，见图ILI9806G控制器内部框图 。

![image-20221224101153560](野火--霸天虎视频学习.assets/image-20221224101153560.png)

* 该芯片最主核心部分是位于中间的 GRAM(Graphics RAM)，它就是显存
  
  * GRAM 中每个存储单元都对应着液晶面板的一个像素点。
* GRAM右侧各种模块共同作用把GRAM存储单元的数据转化成液晶面板的控制信号，使像素点呈现特定的颜色，而像素点组合起来则成为一幅完整的图像。

* 框图的左上角为 ILI9806G 的主要控制信号线和配置引脚

  根据其不同状态设置可以使芯片工作在不同的模式，如

  * 配置每个像素点的位数是8、16还是24位
  * 可配置使用SPI接口、8080 接口还是RGB接口与MCU进行通讯
  * MCU通过SPI、8080接口或RGB接口与ILI9806G进行通讯，从而访问它的控制寄存器 (CR)、地址计数器 (AC)、及GRAM。

* 在GRAM的上侧还有一个LED控制器 (LED Controller)

  * LCD为非发光性的显示装置，它需要借助背光源才能达到显示功能，LED控制器就是用来控制液晶屏中的 LED 背光源。

##### 3. 液晶屏的信号线及8080时序

ILI9806G 控制器的通讯方式：

* 由`IM[3:0]`信号线决定
* 本身支持SPI及8080通信方式
* 本示例中液晶屏出厂前已配置好为8080通讯方式（内部已连接好硬件电路），使用16根数据线的RGB565格式且背光 LED 引 脚不与ILI9806G相连，而是直接引出到排针供外部控制器控制。

内部硬件电路连接完，剩下的其它信号线被引出到FPC排线，最后该排线由PCB底板引出到排针，排针再与实验板上的 STM32芯片连接，引出的排针信号线见图液晶屏引出的信号线 。

<img src="野火--霸天虎视频学习.assets/image-20221224102236722.png" alt="image-20221224102236722" style="zoom:50%;" />

这些信号线的说明见表液晶屏引出的信号线说明：

![image-20221224102400726](野火--霸天虎视频学习.assets/image-20221224102400726.png)

>  这些信号线即 8080 通讯接口，带 X 的表示低电平有效，STM32 通过该接口与 ILI9806G 芯片 进行通讯，实现对液晶屏的控制。

通讯的内容主要包括

* 命令：指对ILI9806G的控制指令，MCU可通过8080接口发送命令编码控制ILI9806G的工作方式，例如复位指令、设置光标指令、睡眠模式指令等等

  > 具体的指令在 《ILI9806G-Data Sheet.pdf》数据手册均有详细说明

* 显存数据：即各个像素点的RGB565内容

写命令时序图见下图`使用8080接口写命令时序`：

![image-20221224102732139](野火--霸天虎视频学习.assets/image-20221224102732139.png)

* 第一阶段：传输命令

  * 写命令时序由片选信号`CSX`拉低开始

  * 对数据/命令选择信号线`D/CX`也置低。

    低电平表示写入的是命令地址 (可理解为命令编码，如软件复位命令：0x01)，

  * 以写信号WRX为低，读信号 RDX 为高表示数据传输方向为写入

  * 同时，在数据线 `D[23:0](或 D[15:0]) `输出命令地址

* 第二阶段：传输命令的参数：

  * `D/CX `要置高电平，表示写入的是命令数据.

    > 命令数据是某些指令带有的参数，如复位指令编码为0x01，它后面可以带一个参数，该参数表示多少秒后复位 (实际的复位命令不含参数，此处只是为了讲解指令编码与参数的区别)

  * `WRX`为低，`RDX`为高，同时在数据线输出数据

当需要把像素数据写入GRAM时，过程很类似，把片选信号`CSX`拉低后，再把数据/命令选择信号线`D/CX`置为高电平，这时由 `D[23:0]`传输的数据则会被ILI9806G保存至它的GRAM中。



#### 第4节 使用STM32的FSMC模拟8080时序原理

ILI9806G的8080通讯接口时序可以由STM32使用普通I/O接口进行模拟，但这样效率太低， STM32提供了一种特别的控制方法——使用FSMC接口实现8080时序。

##### 1. FSMC简介

STM32的FSMC外设可以用于控制扩展的外部存储器，而MCU对液晶屏的操作实际上就是把显示数据写入到显存中，与控制存储器非常类似，且8080接口的通讯时序完全可以使用FSMC外设产生，因而非常适合使用FSMC控制液晶屏。

FSMC外设的结构见图：`FSMC结构图`

<img src="野火--霸天虎视频学习.assets/image-20221224112820901.png" alt="image-20221224112820901" style="zoom:67%;" />

控制LCD时，使用FSMC的`NOR/PSRAM`模式，与前面控制SRAM稍有不同，控制SRAM使用的是模式A，而<font color=red>控制LCD使用的是`NOR FLASH`一样的模式B</font>。

我们重点分析框图中`NOR FLASH`控制信号线部分，如下表所示：`表 FSMC控制NOR_FLASH的信号线`

![image-20221224113707823](野火--霸天虎视频学习.assets/image-20221224113707823.png)

在控制LCD时，使用的是类似异步、地址与数据线独立的`NOR FLASH`控制方式，所以实际上CLK、NWAIT、NADV引脚并没有使用到。

`FSMC NOR/PSRAM`中的模式B的写时序见图：`FSMC写NOR_FLASH的时序图`

<img src="野火--霸天虎视频学习.assets/image-20221224114142421.png" alt="image-20221224114142421" style="zoom: 50%;" />

* 根据STM32对寻址空间的地址映射，地址`0x6000 0000 ~0x9FFF FFFF`是映射到外部存储器的，而其中的`0x6000 0000 ~0x6FFF FFFF`则是分配给`NOR FLASH`、`PSRAM`这类可直接寻址的器件。
* FSMC工程流程：
  * 当FSMC外设被配置成正常工作，并且外部接了`NOR FLASH`时，若向`0x60000000`地址写入数据如0xABCD
  * FSMC 会自动在各信号线上产生相应的电平信号，写入数据。
  * FSMC 会控制片选信号NE1选择相应的NOR芯片
  * 然后使用地址线`A[25:0]`输出0x60000000
  * 在NWE写使能信号线上发出低电平的写使能信号
  * 而要写入的数据信号0xABCD则从数据线`D[15:0]`输出，然后数据就被保存到`NOR FLASH`中了

##### 2. 用FSMC模拟8080时序

下图为NOR模式B时序与8080时序的对比图：

![image-20221224153143404](野火--霸天虎视频学习.assets/image-20221224153143404.png)

对比`FSMC NOR/PSRAM`中的模式B时序与ILI9806G液晶控制器芯片使用的8080时序可发现，这<font color=red>两个时序是十分相似的 (除了FSMC的地址线A和8080的D/CX线</font>，可以说是完全一样)。

下表对比两种时序的引脚：`表FSMC的NOR与8080信号线对比`

![image-20221224153453013](野火--霸天虎视频学习.assets/image-20221224153453013.png)

对于 FSMC 和 8080 接口：

* 前4种信号线都是完全一样的
* FSMC的地址信号线`A[25:0]`与8080的数据/命令选择线`D/CX`有区别

**使用FSMC的地址线模拟8080接口的`D/CX`信号线**

* <font color=red>把FSMC的A0地址线 (也可以使用其它A1/A2等地址线)与ILI9806G芯片8080接口的`D/CX`信号线连接</font>

  * 当A0为高电平时(即`D/CX`为高电平)，数据线`D[15:0]`的信号会被 ILI9806G 理解为数值
  * 当A0为低电平时(即`D/CX`为低电平)，传输的信号则会被理解为命令

*  FSMC会自动产生地址信号

  * 当使用FSMC向0x6xxx xxx1、0x6xxx xxx3、0x6xxx xxx5…这些奇数地址写入数据时，地址最低位的值均为1，所以它会控制地址线`A0(D/CX)`输出高电平

  * 若向0x6xxx xxx0 、0x6xxx xxx2、0x6xxx xxx4… 这些偶数地址写入数据时，地址最低位的值均为0，所以它会控制地址线A0(D/CX)输出低电平

  * 见表`使用FSMC输出地址示例`

    ![image-20221224154538727](野火--霸天虎视频学习.assets/image-20221224154538727.png)

有了这个基础，只要配置好FSMC外设，然后在代码中利用指针变量，向不同的地址单元写入数据，就能够由 FSMC 模拟出的8080接口向ILI9806G写入控制命令或GRAM的数据了。

> 注意：在实际控制时，以上地址计算方式还不完整，还需要注意HADDR内部地址与FSMC地址信号线的转换，关于这部分内容在代码讲解时再详细举例说明。

#### 第5节 FSMC控制相关的结构体

##### 1. NOR FLASH时序结构体

控制FSMC使用`NOR FLASH`存储器时主要是配置：

* 时序寄存器
* 控制寄存器

利用ST标准的时序结构体以及初始化结构体可以很方便地写入参数

NOR FLASH时序结构体的成员如下：

```c
typedef struct
{
	uint32_t FSMC_AddressSetupTime; /* 地址建立时间，0-0xF个HCLK周期 */
	uint32_t FSMC_AddressHoldTime; /* 地址保持时间，0-0xF个HCLK周期 */
	uint32_t FSMC_DataSetupTime; /* 地址建立时间，0-0xF个HCLK周期 */
	uint32_t FSMC_BusTurnAroundDuration;/* 总线转换周期,0-0xF个HCLK周期，在NOR FLASH*/
	uint32_t FSMC_CLKDivision;/* 时钟分频因子,1-0xF，若控制异步存储器，本参数无效 */
	uint32_t FSMC_DataLatency; /* 数据延迟时间，若控制异步存储器，本参数无效 */
	uint32_t FSMC_AccessMode; /* 设置访问模式 */
}FSMC_NORSRAMTimingInitTypeDef;
```

下面仅列出控制NOR FLASH时使用模式B用到的结构体成员说明：

* `FSMC_AddressSetupTime`

  本成员设置地址建立时间，即FSMC读写时序图FSMC写`NOR FLASH`的时序图中的ADDSET值，它可以被设置为`0-0xF`个HCLK周期数，按STM32标准库的默认配置，HCLK的时钟频率为168MHz，即一个HCLK周期为`1/168`微秒。

* `FSMC_DataSetupTime`

  本成员设置数据建立时间，即FSMC读写时序图FSMC写`NOR FLASH`的时序图中的DATAST值，它可以被设置为 `0-0xF`个HCLK周期数。

* `FSMC_AccessMode`

  本成员设置存储器访问模式，不同的模式下FSMC访问存储器地址时引脚输出的时序不一样，可选`FSMC AccessMode A/B/C/D`模式。控制异步`NOR FLASH`时使用B模式。

##### 2. FSMC初始化结构体

FSMC控制NOR FLASH相关的结构体：

```c
typedef struct
{
	uint32_t FSMC_Bank; /* 设置要控制的 Bank 区域 */
	uint32_t FSMC_DataAddressMux; /* 设置地址总线与数据总线是否复用 */
	uint32_t FSMC_MemoryType; /* 设置存储器的类型 */
	uint32_t FSMC_MemoryDataWidth; /* 设置存储器的数据宽度 */
	uint32_t FSMC_BurstAccessMode; /* 设置是否支持突发访问模式，只支持同步类型的存储器*/
	uint32_t FSMC_AsynchronousWait; /* 设置是否使能在同步传输时的等待信号，*/
	uint32_t FSMC_WaitSignalPolarity; /* 设置等待信号的极性 */
	uint32_t FSMC_WrapMode; /* 设置是否支持对齐的突发模式 */
	uint32_t FSMC_WaitSignalActive; /* 配置等待信号在等待前有效还是等待期间有效 */
	uint32_t FSMC_WriteOperation; /* 设置是否写使能 */
	uint32_t FSMC_WaitSignal; /* 设置是否使能等待状态插入 */
	uint32_t FSMC_ExtendedMode; /* 设置是否使能扩展模式 */
	uint32_t FSMC_WriteBurst; /* 设置是否使能写突发操作*/
	/* 当不使用扩展模式时，本参数用于配置读写时序，否则用于配置读时序 */
	FSMC_NORSRAMTimingInitTypeDef* FSMC_ReadWriteTimingStruct;
	/* 当使用扩展模式时，本参数用于配置写*/
	FSMC_NORSRAMTimingInitTypeDef* FSMC_WriteTimingStruct;
}FSMC_NORSRAMInitTypeDef;
```

下面只列出与NOR FLASH模式B相关的一些结构体成员的说明：

* `FSMC_Bank`

  本成员用于选择FSMC映射的存储区域，它的可选参数以及相应的内核地址映射范围见下表：

  ![image-20221224161711968](野火--霸天虎视频学习.assets/image-20221224161711968.png)

* `FSMC_MemoryType`

  本成员用于设置要控制的存储器类型，它支持控制的存储器类型为SRAM、PSRAM以及NOR FLASH(`FSMC_MemoryType_SRAM/PSRAM/NOR`)。

* `FSMC_MemoryDataWidth`

  本成员用于设置要控制的存储器的数据宽度，可选择设置成8或16位(`FSMC_MemoryDataWidth_8b/16b`)。

* `FSMC_WriteOperation`

  这个成员用于设置是否写使能(`FSMC_WriteOperation_ Enable /Disable`)，禁止写使能的话FSMC只能从存储器中读取数据，不能写入。

* `FSMC_ExtendedMode`

  本成员用于设置是否使用扩展模式 (`FSMC_ExtendedMode_Enable/Disable`)

  * 在非扩展模式下，对存储器读写的时序都只使用`FSMC_BCR`寄存器中的配置，即下面的`FSMC_ReadWriteTimingStruct`结构体成员；
  * 在扩展模式下，对存储器的读写时序可以分开配置
    * 读时序使用`FSMC_BCR`寄存器
    * 写时序使用 `FSMC_BWTR`寄存器的配置，即后面的`FSMC_WriteTimingStruct`结构体成员。

* `FSMC_ReadWriteTimingStruct`

  本成员是一个指针， 赋值时使用上一小节中讲解的时序结构体`FSMC_NORSRAMInitTypeDef`设置，当不使用扩展模式时，读写时序都使用本成员的参数配置。

* `FSMC_WriteTimingStruct`

  本成员也是一个时序结构体的指针，只有当使用扩展模式时，本配置才有效，它是写操作使用的时序。

对本结构体赋值完成后，调用`FSMC_NORSRAMInit`库函数即可把配置参数写入到`FSMC_BCR`及`FSMC_BTR/BWTR`寄存器中。